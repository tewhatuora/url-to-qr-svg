<!DOCTYPE html>
<html lang="en">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>URL to QR code</title>
	<header>
		<h1>Convert a URL to a QR Code</h1>
		<p>This page can create a QR Code for you (in SVG format), if you supply a URL.</p>
	</header>
	<main>
		<form action="." method="GET">
			<div class="form_row">
				<label for="form_field_url">
					<abbr title="Uniform resource locator">URL</abbr> / Web address
				</label>
				<div class="form_field">
					<input 
						tpye="url"
						id="form_field_url"
						name="url"
						required
						maxlength="428"
						placeholder="e.g. https://tewhatuora.govt.nz"
						value="">
				</div>
			</div>
			<div class="button_row">
				<button type="submit" class="button button_primary">Convert</button>
			</div>
		</form>
		<div id="result" hidden>
			<div class="container_svg"></div>
			<a download="qrcode.svg">Download SVG</a>
		</div>
	</main>
	<footer>

	</footer>
	<script src="./node_modules/@lemaik/qrcode-svg/dist/qrcode.min.js"></script>
	<script>
		((T,W,O) => {

			const SELECTOR_RESULT_CONTAINER = '#result',
			      SELECTOR_SVG_CONTAINER = `${SELECTOR_RESULT_CONTAINER} .container_svg`,
			      SELECTOR_DOWNLOAD_LINK = `${SELECTOR_RESULT_CONTAINER} a[download]`,
			      MIME_TYPE_SVG = 'image/svg+xml',
			      FORM_FIELD_NAME_URL = 'url',
			      FILENAME_PREFIX = 'qrcode',
			      FILENAME_SUFFIX = '.svg',
			      ELEMENT_RESULT = T.querySelector(SELECTOR_RESULT_CONTAINER),
			      ELEMENT_SVG_CONTAINER = T.querySelector(SELECTOR_SVG_CONTAINER),
			      ELEMENT_DOWNLOAD_LINK = T.querySelector(SELECTOR_DOWNLOAD_LINK);

			let urlValue = null;

			function generateSafeFilename() {
				let urlString = urlValue.split('://')[1].replace(/[^a-zA-Z0-9]/g, '_');
				return `${FILENAME_PREFIX}-${W.encodeURIComponent(urlString)}${FILENAME_SUFFIX}`;
			}

			function generateDownloadLinkFromSVG(svgElemText) {
				let svgBlob = new Blob([svgElemText], {type:MIME_TYPE_SVG});
				ELEMENT_DOWNLOAD_LINK.href = W.URL.createObjectURL(svgBlob);
				ELEMENT_DOWNLOAD_LINK.download = generateSafeFilename();
			}

			function convertStringToQRCodeSVG() {
				let qrcode = new QRCode({
					content: urlValue,
					xmlDeclaration: false,
				});
				let svgElemText = qrcode.svg();

				generateDownloadLinkFromSVG(svgElemText);

				ELEMENT_SVG_CONTAINER.innerHTML = svgElemText;
				ELEMENT_RESULT.hidden = false;
			}

			function handleSubmit(event) {
				event.preventDefault();

				urlValue = new FormData(event.target).get(FORM_FIELD_NAME_URL);
				convertStringToQRCodeSVG();
			}

			T.addEventListener('submit', handleSubmit);

		})(document, window);
	</script>